# Журнал архитектурных решений (ADR)

## Формат записи

```
## [ДАТА] Название решения

**Контекст**: Почему возникла необходимость
**Решение**: Что было решено
**Альтернативы**: Какие варианты рассматривались
**Последствия**: К чему привело решение
```

---

## [2025-01] localStorage как источник истины для LiveOps

**Контекст**: 
При использовании Zustand store для LiveOps событий возникали проблемы синхронизации — state мог откатываться при ре-рендерах компонентов.

**Решение**: 
Сделать localStorage единственным источником истины. Все функции (getDungeonDigEvent, saveDungeonDigEvent и т.д.) читают/пишут напрямую в localStorage, а не в React state.

**Альтернативы**:
- Zustand persist middleware — сложнее отлаживать
- React Context — проблемы с производительностью

**Последствия**:
- ✅ Стабильное состояние между сессиями
- ✅ Простая отладка (можно смотреть localStorage)
- ⚠️ Нужно вручную триггерить ре-рендер

---

## [2025-01] pointer-events-none для анимируемых карт

**Контекст**:
Баг дублирования карт: при быстром клике на карту под анимируемой картой создавался дубликат.

**Решение**:
Добавить `pointer-events-none` к картам с `isAnimating` или `isDragging`.

**Альтернативы**:
- Блокировка кликов через ref с таймером — ненадёжно
- Глобальная блокировка во время анимации — ломает UX

**Последствия**:
- ✅ Полностью решает проблему дублирования
- ✅ Не влияет на производительность
- ✅ Работает и на desktop, и на mobile

---

## [2025-01] Модульная структура LiveOps событий

**Контекст**:
Первый ивент (Treasure Hunt) был реализован в нескольких файлах без чёткой структуры. При добавлении второго ивента (Dungeon Dig) стало сложно поддерживать код.

**Решение**:
Стандартная структура для каждого ивента:
```
liveops/eventName/
├── types.ts      # Типы данных
├── logic.ts      # Бизнес-логика и конфиги
├── storage.ts    # localStorage операции
├── store.ts      # Zustand store (опционально)
└── index.ts      # Public API
```

**Последствия**:
- ✅ Легко добавлять новые ивенты
- ✅ Чёткое разделение ответственности
- ✅ Переиспользование паттернов

---

## [2025-01] useTouchDrag с onTap callback

**Контекст**:
На мобильных устройствах tap и drag обрабатывались по-разному в разных компонентах. Некоторые компоненты (FoundationPile) не реагировали на tap.

**Решение**:
Добавить опциональный `onTap` callback в `useTouchDrag` hook. Если touch завершился без движения (< 15px), вызывается onTap.

**Альтернативы**:
- Отдельные обработчики onClick и onTouch — дублирование кода
- Синтетические click события — ненадёжно в WebView

**Последствия**:
- ✅ Единообразное поведение на всех платформах
- ✅ Чёткое разделение tap vs drag

---

## [2025-01] Проверка foundation-to-tableau в "нет ходов"

**Контекст**:
Игра показывала "нет ходов", хотя игрок мог вернуть карту из foundation на tableau и продолжить игру.

**Решение**:
Добавить в `getHint()` проверку: можно ли вернуть карту из foundation и получит ли это пользу (есть карта для размещения на неё).

**Последствия**:
- ✅ Более точное определение "нет ходов"
- ✅ Подсказка предлагает этот ход

---

## [2025-01] Debug logger для Telegram WebView

**Контекст**:
В Telegram WebView на мобильных устройствах нет доступа к console. Невозможно отлаживать баги.

**Решение**:
Создать `debugLogger.ts` который:
- Перехватывает console.log/warn/error
- Сохраняет в массив
- Показывает в popup через меню настроек

**Последствия**:
- ✅ Возможность отладки на мобильных
- ✅ Копирование логов для анализа

---

## [2025-01] Декомпозиция GameBoard.tsx

**Контекст**: 
GameBoard.tsx вырос до 4977 строк, 156 hooks, 27 handlers. "God component" сложно поддерживать.

**Решение (итеративное)**:

**Фаза 1 (завершена)**:
1. `LockedFeaturePopup.tsx` — универсальный компонент для 4 locked popups
2. `useGameProgress.ts` — хук для управления звёздами и unlocks (интегрирован)
3. `useDailyQuests.ts` — хук для daily quests логики (интегрирован)

**Фаза 1.5 (завершена)**:
4. `UnlockPopup.tsx` — универсальный компонент для 3 unlock popups (collections, leaderboard, promo)
   - Конфигурации в UNLOCK_CONFIGS
   - Touch-friendly закрытие

**Фаза 2 (завершена)**:
5. `TopEventBar.tsx` — компонент верхней панели ивентов (Points Event, Treasure Hunt, Dungeon Dig, Promo)
   - 447 строк, заменяет ~340 строк inline JSX
   - Экспортирует `FlyingRewardToMiniature` тип
6. `BottomButtonRow.tsx` — компонент нижних кнопок (Undo, Hint, Quests, Shop, Collections, Leaderboard)
   - 303 строки, заменяет ~257 строк inline JSX
   - Включает CollectionPackIcon и secondary collections button

**Результат**:
- GameBoard.tsx: 4977 → 4087 строк (-890)
- 7 переиспользуемых модулей

**Фаза 3 (завершена)**:
7. `useLiveOpsEvents.ts` — хук для таймеров и базового состояния событий (350 строк)
   - State для TreasureHunt и DungeonDig
   - Таймеры с автообновлением
   - Auto-deactivation при истечении и потраченных ресурсах
   - Callbacks для side effects (onTreasureHuntExpired, onDungeonDigExpired)
   - Actions: addKey, addShovel, activate, deactivate, reset
   - Удалено ~97 строк из GameBoard

**Результат**:
- GameBoard.tsx: 4977 → **3991** строк (**-986**)
- 8 переиспользуемых модулей

**Следующие шаги**:
- `useWinFlow.ts` — хук для цепочки после победы
- Дальнейшая декомпозиция по необходимости

---

## Шаблон для новых решений

```
## [ДАТА] Название

**Контекст**: 

**Решение**: 

**Альтернативы**:

**Последствия**:
```
